name: Audio-Algo Unittest
on: [pull_request]

env:
  DURATION_LIMIT: 15

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  Environment_Setup:
    runs-on: [self-hosted, Linux, X64, aiteam]
    container:
      image: 10.58.1.67:32000/audioalgo:latest
      volumes:
        - /home/aidata/github_actions/unittest/:/workspace/unittest
        - /home/aidata/ui_db/action/testset/:/workspace/testset/
    steps:
      - uses: actions/checkout@v2
      - name: Setup git user
        run: |
          git config --global user.name "$(git --no-pager log --format=format:'%an' -n 1)"
          git config --global user.email "$(git --no-pager log --format=format:'%ae' -n 1)"
      - name: Get branch name (merge)
        if: github.event_name != 'pull_request'
        shell: bash
        run: echo "BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr / -)" >> $GITHUB_ENV
      - name: Get branch name (pull request)
        if: github.event_name == 'pull_request'
        shell: bash
        run: echo "BRANCH_NAME=$(echo ${GITHUB_HEAD_REF} | tr / -)" >> $GITHUB_ENV
      - name: Echo branch name
        id: branch-name
        run: |
          echo ${{ env.BRANCH_NAME }}
    outputs:
      BRANCH_NAME: ${{ env.BRANCH_NAME }}

  Build:
    strategy:
      matrix:
        platform: [x86, gen4c, gen4l]
        include:
          - platform: x86
            test: -t

    runs-on: [self-hosted, Linux, X64, aiteam]
    needs: Environment_Setup
    container:
      image: 10.58.1.67:32000/audioalgo:latest
      volumes:
        - /home/aidata/github_actions/github_actions_3rdparty/:/workspace/github_actions_3rdparty
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: Copy actions
        shell: bash
        run: |
          mkdir -p .github/github_actions_3rdparty
          cp -fr /workspace/github_actions_3rdparty/ai-team.github-actions ./.github/github_actions_3rdparty
      - name: Install ai-tools
        uses: ./.github/github_actions_3rdparty/ai-team.github-actions/install-aitools
      - name: Build
        shell: bash
        run: |
          rm -rf ~/.ubnt_audio/cache
          ./cmake/utils/compile -p ${{ matrix.platform }} ${{ matrix.test }}
      - name: Cache build result
        uses: actions/cache@v2
        with:
          path: ./build/${{ matrix.platform }}/MinSizeRel/rootfs
          key: unittest-${{ matrix.platform }}-buildresult-${{ needs.Environment_Setup.outputs.BRANCH_NAME }}-${{ github.run_id }}
      - name: Run Unittest x86
        if: matrix.platform == 'x86'
        working-directory: ./build/x86/MinSizeRel/work/
        shell: bash
        run: |
          ctest -T test --no-compress-output
    outputs:
      BRANCH_NAME: ${{ needs.Environment_Setup.outputs.BRANCH_NAME }}

  Lite_Dataset_Audio_Detect_Eval:
    strategy:
      fail-fast: false
      matrix:
        type: [smoke, co, false_alarm]
        testset: [{ dir: testset_audio_event_detect, tag: unittest_audio_event_detect-20220328 }]
    runs-on: [self-hosted, Linux, X64, aiteam]
    needs: Build
    container:
      image: 10.58.1.67:32000/audioalgo:latest
      volumes:
        - /home/aidata/github_actions/unittest/unittest/:/workspace/unittest
        - /home/aidata/ui_db/action/testset/:/workspace/testset/
        - /home/aidata/github_actions/github_actions_3rdparty/:/workspace/github_actions_3rdparty
    steps:
      - uses: actions/checkout@v2
      - name: Copy actions
        shell: bash
        run: |
          mkdir -p .github/github_actions_3rdparty
          cp -fr /workspace/github_actions_3rdparty/ai-team.github-actions ./.github/github_actions_3rdparty
      - name: Install ai-tools
        uses: ./.github/github_actions_3rdparty/ai-team.github-actions/install-aitools
      - name: Get Cache x86 build result
        uses: actions/cache@v2
        with:
          path: ./build/x86/MinSizeRel/rootfs
          key: unittest-x86-buildresult-${{ needs.Build.outputs.BRANCH_NAME }}-${{ github.run_id }}
      - name: Set pythonpath
        run: |
          echo "LD_LIBRARY_PATH=./build/x86/MinSizeRel/rootfs/lib/:$LD_LIBRARY_PATH" >> $GITHUB_ENV
      - name: Checkout testset to the tag version
        working-directory: /workspace/testset/${{ matrix.testset.dir }}
        shell: bash
        run: source ${{ env.ai_tools }}/database/dvc/uid.bash && uid checkout ${{ matrix.testset.tag }}
      - name: Run evaluation
        shell: bash
        run: |
          mkdir -p /workspace/${{ matrix.type }}_eval_output
          python3 ./unittest/audio_event_eval.py \
          --type ${{ matrix.type }} \
          --dataset /workspace/testset/${{ matrix.testset.dir }}/${{ matrix.type }} \
          --output /workspace/${{ matrix.type }}_eval_output